name: Deploy Manually

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "19.x"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('frontend/app/package-lock.json') }}
          restore-keys: |
            npm-

      - name: Install dependencies
        working-directory: ./frontend/app
        run: npm ci --prefer-offline --no-audit

      - name: Create required directories
        run: mkdir -p frontend/app/site

      - name: Run data copy script
        run: |
          chmod +x ./copy_data_to_submodule.sh
          ./copy_data_to_submodule.sh

      - name: Validate and remove invalid JSON files
        working-directory: ./frontend/app
        run: |
          echo "ðŸ” Validating all JSON files in site/_data..."
          echo ""
          
          invalid_count=0
          valid_count=0
          
          # Create a temporary file to store invalid file paths
          > /tmp/invalid_files.txt
          
          # Find and validate all .json files
          while IFS= read -r file; do
            echo "Checking: $file"
            
            # Try to parse the JSON file with Python
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "  âœ… Valid JSON"
              ((valid_count++))
            else
              echo "  âŒ Invalid JSON detected"
              echo "  First 5 lines of problematic file:"
              head -n 5 "$file" 2>/dev/null || echo "  (unable to read file)"
              echo "  Removing: $file"
              echo "$file" >> /tmp/invalid_files.txt
              rm "$file"
              ((invalid_count++))
            fi
            echo ""
          done < <(find ./site/_data -name "
          *.json" -type f)
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š JSON Validation Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Valid files:   $valid_count"
          echo "âŒ Invalid files: $invalid_count"
          
          if [ $invalid_count -gt 0 ]; then
            echo ""
            echo "âš ï¸  The following files were removed due to invalid JSON:"
            cat /tmp/invalid_files.txt
            echo ""
            echo "Please notify contributors to fix these files."
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build project
        working-directory: ./frontend/app
        run: npm run build

      - name: Setup GitHub pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/app/dist

      - name: Deploy to GitHub pages
        uses: actions/deploy-pages@v4