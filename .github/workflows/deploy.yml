name: Deploy Manually

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "19.x"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('frontend/app/package-lock.json') }}
          restore-keys: |
            npm-

      - name: Install dependencies
        working-directory: ./frontend/app
        run: npm ci --prefer-offline --no-audit

      - name: Create required directories
        run: mkdir -p frontend/app/site

      - name: Run data copy script
        run: |
          chmod +x ./copy_data_to_submodule.sh
          ./copy_data_to_submodule.sh

      - name: Validate and clean invalid JSON files
        working-directory: ./frontend/app
        run: |
          echo "üîç Validating JSON files in site/_data..."
          
          invalid_count=0
          valid_count=0
          
          # Find all .json files in the data directory
          find ./site/_data -name "
          *.json" -type f | while read file; do
            echo "Checking: $file"
            
            # Try to parse the JSON file
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "  ‚úÖ Valid JSON"
              valid_count=$((valid_count + 1))
            else
              echo "  ‚ùå Invalid JSON detected"
              echo "  First 10 lines of file:"
              cat "$file" | head -n 10 || echo "  (unable to read file)"
              echo "  Removing invalid file: $file"
              rm "$file"
              invalid_count=$((invalid_count + 1))
            fi
          done
          
          echo ""
          echo "üìä Validation Summary:"
          echo "  Valid files: $valid_count"
          echo "  Invalid files removed: $invalid_count"
          echo "‚úÖ JSON validation complete"

      - name: Build project
        working-directory: ./frontend/app
        run: npm run build

      - name: Setup GitHub pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/app/dist

      - name: Deploy to GitHub pages
        uses: actions/deploy-pages@v4